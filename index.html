<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Habit Tracker</title>
  <style>
    :root {
      --bg: #050505;
      --surface: #121212;
      --surface-2: #1a1a1a;
      --text: #f5f7ff;
      --muted: #9ca3af;
      --primary: #00f2ff;
      --secondary: #ff00ff;
      --border: #2a2a2a;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color: var(--text);
      background: radial-gradient(circle at top right, rgba(255, 0, 255, 0.08), transparent 35%), var(--bg);
    }

    .app {
      width: min(1120px, 94vw);
      margin: 18px auto;
      display: grid;
      gap: 14px;
      grid-template-rows: auto 1fr auto;
      min-height: calc(100vh - 36px);
    }

    .panel {
      background: linear-gradient(165deg, var(--surface-2), var(--surface));
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.02), 0 16px 32px rgba(0, 0, 0, 0.35);
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      padding: 14px;
      flex-wrap: wrap;
    }

    h1 {
      margin: 0;
      font-size: clamp(1.1rem, 2.4vw, 1.6rem);
      letter-spacing: 0.04em;
      text-shadow: 0 0 10px rgba(0, 242, 255, 0.28);
    }

    .meta {
      font-size: 0.86rem;
      color: var(--muted);
      margin-top: 4px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .tabs {
      display: inline-flex;
      gap: 6px;
      background: #0f0f0f;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 4px;
    }

    .tab {
      border: 0;
      background: transparent;
      color: var(--muted);
      border-radius: 999px;
      padding: 9px 13px;
      font-weight: 700;
      cursor: pointer;
    }

    .tab.active {
      color: var(--text);
      background: linear-gradient(90deg, rgba(0,242,255,.18), rgba(255,0,255,.22));
      box-shadow: 0 0 10px rgba(0, 242, 255, 0.26);
    }

    .btn {
      border: 1px solid #30424b;
      background: linear-gradient(120deg, rgba(0,242,255,.14), rgba(255,0,255,.2));
      color: var(--text);
      border-radius: 10px;
      padding: 9px 12px;
      font-weight: 700;
      cursor: pointer;
    }

    main { padding: 14px; }

    .view-title {
      margin: 0 0 10px;
      font-size: 0.95rem;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: #d5d9e2;
    }

    .empty {
      border: 1px dashed #3a3a3a;
      border-radius: 12px;
      background: #0f0f0f;
      color: var(--muted);
      text-align: center;
      padding: 24px;
    }

    .table-wrap { overflow-x: auto; }

    table {
      width: 100%;
      min-width: 840px;
      border-collapse: collapse;
      background: #0f0f0f;
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      border-right: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
      padding: 10px;
      text-align: center;
      font-size: 0.9rem;
    }

    th {
      background: #141414;
      color: #d7dbe3;
      text-transform: uppercase;
      font-size: 0.78rem;
      letter-spacing: .06em;
    }

    th:first-child, td:first-child { text-align: left; }
    tr:last-child td { border-bottom: none; }
    th:last-child, td:last-child { border-right: none; }

    .habit-name { font-weight: 700; }

    input[type="checkbox"] {
      appearance: none;
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 6px;
      border: 1px solid #535353;
      background: #101010;
      cursor: pointer;
      position: relative;
    }

    input[type="checkbox"]:checked {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(0,242,255,.25), rgba(255,0,255,.32));
      box-shadow: 0 0 10px rgba(0, 242, 255, .45);
    }

    input[type="checkbox"]:checked::after {
      content: '';
      position: absolute;
      left: 7px;
      top: 2px;
      width: 5px;
      height: 11px;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }

    .progress-track {
      height: 8px;
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid #2f2f2f;
      background: #1a1a1a;
      margin-bottom: 4px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      box-shadow: 0 0 10px rgba(0,242,255,.5);
    }

    .progress-text { color: #cfd4de; font-size: .78rem; }

    .heatmap {
      display: grid;
      grid-template-columns: repeat(7, minmax(64px, 1fr));
      gap: 10px;
    }

    .cell {
      border: 1px solid #303030;
      border-radius: 10px;
      aspect-ratio: 1/1;
      padding: 8px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      background: #131313;
    }

    .cell small { color: #d8dce6; }
    .cell span { color: #f3f4f8; font-size: 0.78rem; }

    footer {
      padding: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .foot-note { color: var(--muted); font-size: .82rem; }

    @media (max-width: 760px) {
      .heatmap { grid-template-columns: repeat(4, minmax(56px, 1fr)); }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="panel">
      <div>
        <h1>Habit Tracker</h1>
        <div class="meta" id="dateMeta"></div>
      </div>
      <div class="header-right">
        <nav class="tabs" aria-label="View Switcher">
          <button class="tab active" data-view="weekly">Weekly</button>
          <button class="tab" data-view="monthly">Monthly</button>
        </nav>
        <button class="btn" id="exportBtn" title="Export data as JSON">Export JSON</button>
      </div>
    </header>

    <main class="panel" id="mainContent"></main>

    <footer class="panel">
      <div class="foot-note">Data is saved locally in your browser.</div>
      <button class="btn" id="addHabitBtn">+ Add Habit</button>
    </footer>
  </div>

  <script>
    const STORAGE_KEY = 'habit-tracker-single-file-v1';
    const appState = loadFromDisk() || { habits: [] }; // { habits:[{id,name,created,completions:[YYYY-MM-DD]}] }
    let activeView = 'weekly';

    function loadFromDisk() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return null;
      try {
        const parsed = JSON.parse(raw);
        if (!parsed || !Array.isArray(parsed.habits)) return null;
        parsed.habits = parsed.habits.map(h => ({
          id: String(h.id || crypto.randomUUID()),
          name: String(h.name || 'Untitled Habit'),
          created: h.created || new Date().toISOString(),
          completions: Array.isArray(h.completions) ? h.completions : []
        }));
        return parsed;
      } catch {
        return null;
      }
    }

    function saveToDisk() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
    }

    function updateState(mutator) {
      mutator(appState);
      saveToDisk();
      renderActiveView();
    }

    function formatDateKey(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    function getCurrentISOWeekDates(ref = new Date()) {
      const base = new Date(ref);
      const day = base.getDay();
      const mondayShift = day === 0 ? -6 : 1 - day;
      base.setDate(base.getDate() + mondayShift);
      base.setHours(0, 0, 0, 0);
      return Array.from({ length: 7 }, (_, i) => {
        const d = new Date(base);
        d.setDate(base.getDate() + i);
        return d;
      });
    }

    function getCurrentMonthDays(ref = new Date()) {
      const y = ref.getFullYear();
      const m = ref.getMonth();
      const count = new Date(y, m + 1, 0).getDate();
      return Array.from({ length: count }, (_, i) => new Date(y, m, i + 1));
    }

    function isCompletedOn(habit, dateKey) {
      return habit.completions.includes(dateKey);
    }

    function toggleCompletion(habitId, dateKey, checked) {
      updateState((state) => {
        const habit = state.habits.find(h => h.id === habitId);
        if (!habit) return;
        const set = new Set(habit.completions);
        if (checked) set.add(dateKey);
        else set.delete(dateKey);
        habit.completions = [...set].sort();
      });
    }

    function weekCompletionCount(habit, weekDates) {
      return weekDates.reduce((count, d) => count + (isCompletedOn(habit, formatDateKey(d)) ? 1 : 0), 0);
    }

    function dayConsistencyRate(dateKey) {
      if (!appState.habits.length) return 0;
      const completed = appState.habits.reduce((sum, h) => sum + (isCompletedOn(h, dateKey) ? 1 : 0), 0);
      return completed / appState.habits.length;
    }

    function setMetaDate() {
      const now = new Date();
      document.getElementById('dateMeta').textContent = now.toLocaleString(undefined, {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      });
    }

    function renderActiveView() {
      setMetaDate();
      const main = document.getElementById('mainContent');
      main.innerHTML = '';
      if (activeView === 'weekly') main.appendChild(renderWeeklyView());
      else main.appendChild(renderMonthlyView());
    }

    function renderWeeklyView() {
      const root = document.createElement('section');
      const weekDates = getCurrentISOWeekDates();
      const start = weekDates[0].toLocaleDateString();
      const end = weekDates[6].toLocaleDateString();
      root.innerHTML = `<h2 class="view-title">Week (Mon–Sun): ${start} → ${end}</h2>`;

      if (!appState.habits.length) {
        root.innerHTML += '<div class="empty">No habits yet. Add one below.</div>';
        return root;
      }

      const wrap = document.createElement('div');
      wrap.className = 'table-wrap';
      const table = document.createElement('table');

      const headerDays = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
      table.innerHTML = `<thead><tr><th>Habit</th>${headerDays.map(d => `<th>${d}</th>`).join('')}<th>Progress</th></tr></thead><tbody></tbody>`;
      const tbody = table.querySelector('tbody');

      appState.habits.forEach((habit) => {
        const tr = document.createElement('tr');
        const completed = weekCompletionCount(habit, weekDates);
        const percent = Math.round((completed / 7) * 100);

        let row = `<td><div class="habit-name">${escapeHTML(habit.name)}</div></td>`;
        weekDates.forEach((d) => {
          const key = formatDateKey(d);
          const checked = isCompletedOn(habit, key) ? 'checked' : '';
          row += `<td><input type="checkbox" data-habit-id="${habit.id}" data-date="${key}" ${checked} aria-label="${habit.name} ${key}"></td>`;
        });

        row += `<td>
          <div class="progress-track"><div class="progress-fill" style="width:${percent}%"></div></div>
          <div class="progress-text">${completed}/7 (${percent}%)</div>
        </td>`;

        tr.innerHTML = row;
        tbody.appendChild(tr);
      });

      wrap.appendChild(table);
      root.appendChild(wrap);

      root.querySelectorAll('input[type="checkbox"]').forEach((box) => {
        box.addEventListener('change', (event) => {
          const { habitId, date } = event.target.dataset;
          toggleCompletion(habitId, date, event.target.checked);
        });
      });

      return root;
    }

    function renderMonthlyView() {
      const root = document.createElement('section');
      const now = new Date();
      const monthDays = getCurrentMonthDays(now);
      root.innerHTML = `<h2 class="view-title">Month: ${now.toLocaleString(undefined, { month: 'long', year: 'numeric' })}</h2>`;

      if (!appState.habits.length) {
        root.innerHTML += '<div class="empty">No habits available for analytics yet.</div>';
        return root;
      }

      const heatmap = document.createElement('div');
      heatmap.className = 'heatmap';

      for (let day = 1; day <= 31; day++) {
        const cell = document.createElement('div');
        cell.className = 'cell';

        const date = monthDays[day - 1];
        if (date) {
          const key = formatDateKey(date);
          const rate = dayConsistencyRate(key);
          const alphaA = 0.08 + rate * 0.6;
          const alphaB = 0.12 + rate * 0.72;
          cell.style.background = `linear-gradient(145deg, rgba(0,242,255,${alphaA}), rgba(255,0,255,${alphaB}))`;
          cell.style.boxShadow = rate > 0 ? `0 0 ${6 + rate * 18}px rgba(0, 242, 255, ${rate * 0.45})` : 'none';
          cell.innerHTML = `<small>Day ${day}</small><span>${Math.round(rate * 100)}%</span>`;
          cell.title = `${key}: ${Math.round(rate * 100)}% consistency`;
        } else {
          cell.style.opacity = '0.28';
          cell.innerHTML = `<small>--</small><span>N/A</span>`;
        }

        heatmap.appendChild(cell);
      }

      root.appendChild(heatmap);
      return root;
    }

    function bindViewSwitcher() {
      document.querySelectorAll('.tab').forEach((btn) => {
        btn.addEventListener('click', () => {
          activeView = btn.dataset.view;
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          btn.classList.add('active');
          renderActiveView();
        });
      });
    }

    function bindAddHabit() {
      document.getElementById('addHabitBtn').addEventListener('click', () => {
        const name = prompt('Habit name:');
        if (!name || !name.trim()) return;
        updateState((state) => {
          state.habits.push({
            id: crypto.randomUUID(),
            name: name.trim(),
            created: new Date().toISOString(),
            completions: []
          });
        });
      });
    }

    function bindExport() {
      document.getElementById('exportBtn').addEventListener('click', () => {
        const blob = new Blob([JSON.stringify(appState, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `habit-tracker-export-${formatDateKey(new Date())}.json`;
        a.click();
        URL.revokeObjectURL(url);
      });
    }

    function escapeHTML(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function init() {
      bindViewSwitcher();
      bindAddHabit();
      bindExport();
      renderActiveView();
    }

    init();
  </script>
</body>
</html>
